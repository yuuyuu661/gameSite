<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"/>
  <title>Mini Games â†’ Gachapon Serials</title>
  <link rel="stylesheet" href="/style.css"/>
<script type="module">
  import {
    getDisplayName,
    setDisplayName,
    getPoints,
    latestSerials,
    generateSerial,
  } from "/js/common.js";

  async function refresh() {
    const name = getDisplayName();
    const nameText = document.querySelector("#playerNameText");
    const overlay = document.querySelector("#name-overlay");
    const pointsEl = document.querySelector("#points");
    const serialBox = document.querySelector("#serials");

    if (!name) {
      // åå‰æœªè¨­å®šãªã‚‰ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¡¨ç¤º
      overlay.style.display = "flex";
      nameText.textContent = "æœªè¨­å®š";
      pointsEl.textContent = "-";
      serialBox.innerHTML =
        "<div class='small'>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>";
      return;
    }

    // åå‰è¨­å®šæ¸ˆã¿
    overlay.style.display = "none";
    nameText.textContent = name;

    try {
      const pts = await getPoints();
      pointsEl.textContent = pts.points ?? 0;

      const ls = await latestSerials(5);
      const serials = ls.serials || [];
      serialBox.innerHTML =
        serials
          .map(
            (s) => `
        <div class="kv">
          <div><b>${s.code}</b> ${s.used ? "(ä½¿ç”¨æ¸ˆ)" : ""}</div>
          <div style="display:flex;gap:6px;align-items:center;">
            <button class="copy" data-code="${s.code}">ã‚³ãƒ”ãƒ¼</button>
            <span class="badge">${new Date(
              s.created_at
            ).toLocaleString()}</span>
          </div>
        </div>
      `
          )
          .join("") || "<div class='small'>ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>";

      serialBox.querySelectorAll("button.copy").forEach((btn) => {
        btn.onclick = async () => {
          const code = btn.getAttribute("data-code");
          try {
            await navigator.clipboard.writeText(code);
            btn.textContent = "ã‚³ãƒ”ãƒ¼æ¸ˆ";
            setTimeout(() => {
              btn.textContent = "ã‚³ãƒ”ãƒ¼";
            }, 1000);
          } catch (e) {
            alert("ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã§ãã¾ã›ã‚“ã§ã—ãŸ");
          }
        };
      });
    } catch (e) {
      console.error(e);
      pointsEl.textContent = "-";
      serialBox.innerHTML = "<div class='small'>èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</div>";
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    const overlayInput = document.querySelector("#overlayName");
    const overlayOk = document.querySelector("#overlay-ok");

    overlayOk.addEventListener("click", () => {
      const v = overlayInput.value.trim();
      if (!v) {
        alert("ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
      }
      setDisplayName(v);
      refresh();
    });

    document.querySelector("#genSerial").addEventListener("click", async () => {
      try {
        const res = await generateSerial();
        if (res && res.error === "not_enough_points") {
          alert(`ãƒã‚¤ãƒ³ãƒˆä¸è¶³: å¿…è¦${res.need}, ç¾åœ¨${res.current}`);
          return;
        }
        if (res && res.code) {
          alert(`ã‚·ãƒªã‚¢ãƒ«ç™ºè¡Œ: ${res.code}`);
        } else {
          alert("ã‚·ãƒªã‚¢ãƒ«ç™ºè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ");
        }
        refresh();
      } catch (e) {
        console.error(e);
        alert("ç™ºè¡Œã‚¨ãƒ©ãƒ¼");
      }
    });

    refresh();
  });
</script>


  <script>
    // ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—æ‹¡å¤§é˜²æ­¢
    let __lastTouchEnd = 0;
    document.addEventListener('touchend', function (e) {
      const now = Date.now();
      if (now - __lastTouchEnd <= 300) { e.preventDefault(); }
      __lastTouchEnd = now;
    }, { passive: false });
  </script>
</head>
<body>
  <div class="name-overlay" id="name-overlay">
      <div class="name-overlay-card">
        <h2>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’å…¥åŠ›</h2>
        <p class="small">ãƒã‚¤ãƒ³ãƒˆãƒ»ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«ä½¿ç”¨ã™ã‚‹åå‰ã§ã™ã€‚</p>
        <input id="overlayName" type="text" placeholder="ä¾‹ï¼‰ã‚†ã†" />
        <button id="overlay-ok" style="margin-top:10px;">OK</button>
      </div>
    </div>

  <div class="container">
    <div class="header">
      <h1>ãƒŸãƒ‹ã‚²ãƒ¼ãƒ  â†’ ã‚¬ãƒãƒ£ãƒãƒ³ã‚·ãƒªã‚¢ãƒ«é€£æº</h1>
      <div class="kv">
        <span class="small">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å</span>
        <b id="playerNameText">æœªè¨­å®š</b>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h3>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h3>
        <div class="kv">
          <span>æ‰€æŒãƒã‚¤ãƒ³ãƒˆ</span>
          <b id="points">-</b>
        </div>
        <div class="kv">
          <button id="genSerial">ã‚·ãƒªã‚¢ãƒ«ç™ºè¡Œ</button>
          <span class="small">â€»ãƒã‚¤ãƒ³ãƒˆæ¶ˆè²»ã§ã‚¬ãƒãƒ£ãƒãƒ³ç”¨ã‚·ãƒªã‚¢ãƒ«ã‚’ç™ºè¡Œ</span>
        </div>
        <h4>æœ€è¿‘ã®ã‚·ãƒªã‚¢ãƒ«</h4>
        <div id="serials" class="list small">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
        <div class="kv">
          <a class="game" href="/leaderboards.html">ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¦‹ã‚‹</a>
        </div>
      </div>

      <div class="card">
        <h3>ãƒŸãƒ‹ã‚²ãƒ¼ãƒ </h3>
        <div class="list">
          <a class="game" href="/games/aim/index.html">ã‚¨ã‚¤ãƒ ç·´ç¿’ï¼ˆAimï¼‰</a>
          <a class="game" href="/games/memory/index.html">ç¥çµŒè¡°å¼±ï¼ˆMemoryï¼‰</a>
          <a class="game" href="/games/numbers/index.html">æ•°å­—ã‚¿ãƒƒãƒ—ï¼ˆNumbersï¼‰</a>
          <a class="game" href="/games/fusion/index.html">ãƒã‚±ãƒ¢ãƒ³ãƒ•ãƒ¥ãƒ¼ã‚¸ãƒ§ãƒ³ã‚¯ã‚¤ã‚º</a>
          <a class="game-card" href="/games/block/index.html">ãƒ–ãƒ­ãƒƒã‚¯ãƒ–ãƒ©ã‚¹ãƒˆï¼ˆBlockï¼‰</a>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
