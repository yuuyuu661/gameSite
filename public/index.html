<!DOCTYPE html>
<html lang="ja"><head><meta charset="utf-8"><title>Slot DEBUG</title>
<style>
  body{font-family:sans-serif;background:#0c1b2a;color:#fff;text-align:center}
  .slot-container{display:flex;justify-content:center;margin:20px auto;gap:8px;width:650px;height:400px}
  .reel-wrapper{display:flex;flex-direction:column;align-items:center}
  .reel{width:100px;height:400px;overflow:hidden;background:#222;border:3px solid gold;box-shadow:0 0 10px gold}
  .symbols{position:relative;top:0;width:100%}
  .symbol{display:flex;align-items:center;justify-content:center;height:100px;font-weight:700}
  .symbol[data-name="seven"]{background:#3a3}
  .symbol[data-name="gem"]{background:#39f}
  .symbol[data-name="bell"]{background:#fc3}
  .symbol[data-name="grape"]{background:#93f}
  .symbol[data-name="lemon"]{background:#ff6}
  .symbol[data-name="slime"]{background:#6cf}
  .symbol[data-name="orb"]{background:#f66}
  button{margin-top:6px}
</style></head>
<body>
  <h2>Slot DEBUG（画像を使わず表示テスト）</h2>
  <div class="slot-container" id="slotContainer">
    <div class="reel-wrapper"><div class="reel"><div class="symbols"></div></div><button class="stop-btn" data-index="0">STOP</button></div>
    <div class="reel-wrapper"><div class="reel"><div class="symbols"></div></div><button class="stop-btn" data-index="1">STOP</button></div>
    <div class="reel-wrapper"><div class="reel"><div class="symbols"></div></div><button class="stop-btn" data-index="2">STOP</button></div>
    <div class="reel-wrapper"><div class="reel"><div class="symbols"></div></div><button class="stop-btn" data-index="3">STOP</button></div>
    <div class="reel-wrapper"><div class="reel"><div class="symbols"></div></div><button class="stop-btn" data-index="4">STOP</button></div>
  </div>
  <button id="start">スタート！</button>
  <div id="coinDisplay">所持コイン: <span id="coins">100</span></div>
  <div id="result" style="margin-top:12px"></div>
<script>
const symbols = [
  { name:"seven"}, {name:"orb"}, {name:"slime"},
  { name:"lemon"}, {name:"grape"}, {name:"bell"}, {name:"gem"}
];
const symbolWeights=[6,6,10,12,18,20,28];
const reels = Array.from(document.querySelectorAll(".reel"));
const reelCount=5, rowsVisible=3;
const coinsEl=document.getElementById("coins");
const resultEl=document.getElementById("result");
const startBtn=document.getElementById("start");
let coins=100, spinningFlags=[], hasChecked=false;

function getRandomSymbol(){
  const total=symbolWeights.reduce((a,b)=>a+b);
  let r=Math.random()*total, acc=0;
  for(let i=0;i<symbols.length;i++){ acc+=symbolWeights[i]; if(r<acc) return symbols[i]; }
  return symbols[symbols.length-1];
}

function createSymbolDiv(sym){
  const d=document.createElement("div");
  d.className="symbol"; d.dataset.name=sym.name; d.textContent=sym.name.toUpperCase();
  return d;
}

function setupReels(){
  reels.forEach(reel=>{
    const c=reel.querySelector(".symbols");
    c.innerHTML="";
    for(let i=0;i<20;i++) c.appendChild(createSymbolDiv(getRandomSymbol()));
    c.style.top="0px";
  });
}

function getVisibleSymbols(){
  const vis=[[],[],[]];
  reels.forEach((reel,col)=>{
    const c=reel.querySelector(".symbols");
    const top=parseFloat(c.style.top)||0;
    const off=Math.round(-top/100);
    const children=c.children;
    for(let row=0;row<rowsVisible;row++){
      const el=children[off+row];
      vis[row][col]=el?.dataset.name||"";
    }
  });
  return vis;
}

function startReel(index){
  const c=reels[index].querySelector(".symbols");
  let pos=0, speed=20, slowing=false;
  function anim(){
    pos+=speed;
    if(pos>=100){
      pos%=100;
      c.insertBefore(c.lastElementChild, c.firstElementChild);
    }
    c.style.top=`-${pos}px`;
    if(slowing){
      speed=Math.max(4, speed*0.94);
      if(speed<=4){
        c.style.top="0px";
        spinningFlags[index]=false;
        if(!spinningFlags.some(f=>f)) checkWinLines();
        return;
      }
    }
    requestAnimationFrame(anim);
  }
  requestAnimationFrame(anim);
}

function stopReel(index){ setTimeout(()=>{ /* immediate stop for debug */ slowing=true; }, 300); }

function checkWinLines(){
  const visible=getVisibleSymbols();
  resultEl.textContent="可視行: "+JSON.stringify(visible[1]); // 中段を表示
}

document.querySelectorAll(".stop-btn").forEach(btn=>{
  btn.addEventListener("click", ()=>{ /* no-op for debug */ });
});

startBtn.addEventListener("click", ()=>{
  if(spinningFlags.some(f=>f)) return;
  hasChecked=false;
  if(coins<10){ resultEl.textContent="コイン不足"; return; }
  coins-=10; coinsEl.textContent=coins;
  resultEl.textContent="";
  setupReels();
  spinningFlags=Array(reelCount).fill(true);
  for(let i=0;i<reelCount;i++) startReel(i);
});

setupReels();
console.log("DEBUG: reels=", reels.length, "symbolsFirst=", document.querySelectorAll(".symbols .symbol").length);
</script>
</body></html>
