<!doctype html><html lang="ja"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"/>
<title>ç¥çµŒè¡°å¼±ï¼ˆMemoryï¼‰</title>
<link rel="stylesheet" href="/style.css"/>
<script type="module">
import { submitScore } from "/js/common.js";

let cards=[], first=null, matched=0, start=0, clicks=0, busy=false;
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a; }
function startGame(){
  const symbols = ["ğŸ","ğŸŒ","ğŸ‡","ğŸ‘","ğŸ’","ğŸ","ğŸ¥","ğŸ‰"]; // 8ç¨® â†’ 4x4
  const deck = shuffle([...symbols,...symbols]);
  const grid = document.querySelector("#grid");
  grid.innerHTML = "";
  cards = []; first=null; matched=0; clicks=0; start = performance.now(); busy=false;
  deck.forEach((sym,i)=>{
    const d = document.createElement("button");
    d.className = "cardtile";
    d.dataset.sym = sym;
    d.textContent = "â“";
    d.addEventListener("click", ()=>flip(d), { passive: true });
    cards.push(d);
    grid.appendChild(d);
  });
}
function flip(d){
  if (busy) return;
  if (d.classList.contains("open")) return;
  d.classList.add("open"); d.textContent = d.dataset.sym; clicks++;
  if (!first){ first = d; return; }
  // second card chosen
  busy = true;
  if (first.dataset.sym === d.dataset.sym){
    // match
    first = null; matched += 1; busy = false;
    if (matched===8){
      const sec = (performance.now()-start)/1000;
      const score = Math.max(0, Math.round(1000 - (sec*20 + (clicks-16)*10)));
      document.querySelector("#info").innerHTML = `ã‚¿ã‚¤ãƒ : ${sec.toFixed(2)}s / ã‚¯ãƒªãƒƒã‚¯: ${clicks} â†’ ã‚¹ã‚³ã‚¢ <b>${score}</b>`;
      submitScore("memory", score, { sec, clicks }).then(r=>{
        if(r?.ok!==false) document.querySelector("#info").innerHTML += `ã€€+<b>${r.addedPoints}</b>pt`;
      });
    }
  } else {
    setTimeout(()=>{
      first.classList.remove("open"); first.textContent="â“";
      d.classList.remove("open"); d.textContent="â“";
      first=null; busy=false;
    }, 600);
  }
}
document.addEventListener("DOMContentLoaded", ()=>{
  document.querySelector("#game").innerHTML = `
    <div class="list">
      <div class="small">åŒã˜çµµæŸ„ã‚’ãƒšã‚¢ã«ã—ã‚ˆã†ï¼ˆ4x4ï¼‰</div>
      <div id="grid" class="card" style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;"></div>
      <div class="kv"><button id="st">ã‚¹ã‚¿ãƒ¼ãƒˆ</button><div id="info" class="small"></div></div>
    </div>`;
  document.querySelector("#st").onclick = startGame;
  const style = document.createElement("style");
  style.textContent = `.cardtile{height:64px;font-size:24px; touch-action: manipulation;}`;
  document.head.appendChild(style);
});

</script>

<script>
// doubleTapGuard: prevent accidental double-tap zoom
let __lastTouchEnd = 0;
document.addEventListener('touchend', function (e) {
  const now = Date.now();
  if (now - __lastTouchEnd <= 300) { e.preventDefault(); }
  __lastTouchEnd = now;
}, { passive: false });
</script>

</head><body>
<div class="container">
  <div class="header">
    <h1>ç¥çµŒè¡°å¼±ï¼ˆMemoryï¼‰</h1>
    <a class="game" href="/">â† ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸</a>
  </div>
  <div class="card" id="game"></div>
</div>
</body></html>