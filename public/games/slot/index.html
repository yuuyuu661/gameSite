<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Slot Machine – Full Integration</title>

<style>
  body {
    font-family: sans-serif;
    text-align: center;
    background-color: #0c1b2a;
    color: #fff;
    margin: 0;
    padding: 0;
  }

  a.back-btn {
    display: inline-block;
    margin: 15px;
    padding: 8px 14px;
    background: #333;
    color: #fff;
    border-radius: 8px;
    text-decoration: none;
  }

  #volume-control {
    margin: 10px auto;
  }

  #slot-container {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-top: 15px;
    overflow: hidden;
    width: 650px;
    margin-left: auto;
    margin-right: auto;
  }

  .reel {
    width: 120px;
    height: 300px;
    overflow: hidden;
    margin: 0 4px;
    border: 2px solid gold;
    border-radius: 10px;
    position: relative;
    background: #111;
  }

  .symbols {
    position: absolute;
    width: 100%;
    top: 0;
  }

  .symbol {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100px;
  }

  .highlight {
    animation: glow 0.6s ease-in-out alternate infinite;
  }

  @keyframes glow {
    0% { box-shadow: 0 0 4px yellow; }
    100% { box-shadow: 0 0 14px yellow; }
  }

  .stop-btn {
    margin-top: 5px;
    padding: 4px 8px;
  }

  #start {
    font-size: 24px;
    margin-top: 30px;
    padding: 10px 20px;
  }

  #points-box {
    margin-top: 20px;
    font-size: 18px;
  }

  .coin {
    position: fixed;
    top: -40px;
    width: 40px;
    animation: fall 1.5s linear forwards;
    z-index: 1000;
  }

  @keyframes fall {
    to {
      top: 100%;
      opacity: 0;
      transform: rotate(720deg);
    }
  }
</style>
</head>

<body>

<a href="/" class="back-btn">← メニューへ戻る</a>

<!-- ▼ 音量スライダー -->
<div id="volume-control">
  BGM 音量: <input type="range" id="volume-slider" min="0" max="100" value="80">
</div>

<!-- ▼ BGM / SE -->
<audio id="bgmNormal" src="sounds/bgm_normal.mp3" loop></audio>
<audio id="bgmBonus"  src="sounds/bgm_bonus.mp3" loop></audio>
<audio id="startSound" src="sounds/start.mp3"></audio>
<audio id="stopSound"  src="sounds/stop.mp3"></audio>
<audio id="win3Sound"  src="sounds/win3.mp3"></audio>
<audio id="win4Sound"  src="sounds/win4.mp3"></audio>
<audio id="win5Sound"  src="sounds/win5.mp3"></audio>
<audio id="loseSound"  src="sounds/lose.mp3"></audio>

<!-- ▼ スロット本体 -->
<div id="slot-container"></div>

<button id="start">スタート！</button>

<div id="points-box">
  所持ポイント：<span id="points">0</span>
</div>

<div id="result" style="margin-top:20px; font-size:20px;"></div>

<script type="module">

import { getDisplayName, getPoints, updatePoints } from "/js/common.js";

/* ==========================================================
    初期設定
========================================================== */
let displayName = null;
let points = 0;

const bgmNormal = document.getElementById("bgmNormal");
const bgmBonus  = document.getElementById("bgmBonus");
const startSound = document.getElementById("startSound");
const stopSound  = document.getElementById("stopSound");
const win3Sound  = document.getElementById("win3Sound");
const win4Sound  = document.getElementById("win4Sound");
const win5Sound  = document.getElementById("win5Sound");
const loseSound  = document.getElementById("loseSound");

window.addEventListener("DOMContentLoaded", async () => {
  displayName = getDisplayName();
  if (!displayName) {
    alert("メニューでプレイヤー名を設定してください");
    location.href = "/";
    return;
  }

  const p = await getPoints();
  points = p.points ?? 0;
  document.getElementById("points").textContent = points;

  const v = document.getElementById("volume-slider").value / 100;
  bgmNormal.volume = bgmBonus.volume = v;
  win3Sound.volume = win4Sound.volume = win5Sound.volume = v;
  startSound.volume = stopSound.volume = loseSound.volume = v;

  bgmNormal.play();
});

/* ==========================================================
    音量スライダー
========================================================== */
document.getElementById("volume-slider").addEventListener("input", e => {
  const v = e.target.value / 100;
  bgmNormal.volume = v;
  bgmBonus.volume  = v;
  startSound.volume = v;
  stopSound.volume  = v;
  win3Sound.volume  = v;
  win4Sound.volume  = v;
  win5Sound.volume  = v;
  loseSound.volume  = v;
});

/* ==========================================================
    スロット設定
========================================================== */
const slotContainer = document.getElementById("slot-container");
const reelCount = 5;
const rowsVisible = 3;

const symbols = [
  { name: "seven", src: "images/seven.png" },
  { name: "orb",   src: "images/orb.png" },
  { name: "slime", src: "images/slime.png" },
  { name: "lemon", src: "images/lemon.png" },
  { name: "grape", src: "images/grape.png" },
  { name: "bell",  src: "images/bell.png" },
  { name: "gem",   src: "images/gem.png" }
];

const weights = [6,6,10,12,18,20,28];

const payout = {
  "seven": {3:50, 4:250, 5:500},
  "gem":   {3:30, 4:150, 5:300},
  "bell":  {3:10, 4:50,  5:100},
  "grape": {3:5,  4:25,  5:50 },
  "lemon": {3:3,  4:15,  5:30 },
  "slime": {3:2,  4:10,  5:20 },
  "orb":   {3:0,  4:0,   5:0 }
};

let reels = [];
let spinning = [];
let checking = false;
let bonusMode = false;

/* ==========================================================
    コイン降下演出
========================================================== */
function dropCoins(count = 40) {
  for (let i = 0; i < count; i++) {
    const c = document.createElement("img");
    c.src = "images/coin.png";
    c.className = "coin";
    c.style.left = Math.random() * window.innerWidth + "px";
    document.body.appendChild(c);
    setTimeout(() => c.remove(), 1500);
  }
}

/* ==========================================================
    リール作成
========================================================== */
function createSymbol() {
  const total = weights.reduce((a,b)=>a+b);
  let rand = Math.random()*total, acc = 0;
  for (let i=0;i<symbols.length;i++){
    acc+=weights[i];
    if(rand<acc) return symbols[i];
  }
  return symbols[symbols.length-1];
}

function setupReels() {
  slotContainer.innerHTML = "";
  reels = [];

  for (let r = 0; r < reelCount; r++) {
    const reel = document.createElement("div");
    reel.className = "reel";

    const list = document.createElement("div");
    list.className = "symbols";

    for (let i = 0; i < 20; i++) {
      const sym = createSymbol();
      const div = document.createElement("div");
      div.className = "symbol";
      const img = document.createElement("img");
      img.src = sym.src;
      img.style.width = "80px";
      img.style.height = "80px";
      img.alt = sym.name;
      div.appendChild(img);
      list.appendChild(div);
    }

    reel.appendChild(list);
    slotContainer.appendChild(reel);

    reels.push({ list, pos: 0, speed: bonusMode ? 35 : 20 });
  }
}

/* ==========================================================
    リール回転
========================================================== */
function spinReel(i) {
  const reel = reels[i];
  function anim() {
    reel.pos += reel.speed;
    if (reel.pos >= 100) {
      const div = document.createElement("div");
      div.className = "symbol";
      const sym = createSymbol();
      const img = document.createElement("img");
      img.src = sym.src;
      img.alt = sym.name;
      img.style.width="80px";
      img.style.height="80px";
      div.appendChild(img);
      reel.list.appendChild(div);
      reel.list.removeChild(reel.list.firstElementChild);
      reel.pos -= 100;
    }

    reel.list.style.top = -reel.pos + "px";

    if (!spinning[i]) {
      if (reel.speed > 1) {
        reel.speed *= 0.92;
      } else {
        const snap = Math.round(reel.pos/100)*100;
        reel.list.style.top = -snap + "px";
        return;
      }
    }
    requestAnimationFrame(anim);
  }
  requestAnimationFrame(anim);
}

/* ==========================================================
    判定
========================================================== */
function visibleSymbols() {
  const lines = [[],[],[]];
  reels.forEach((reel, col)=>{
    const top = parseFloat(reel.list.style.top)||0;
    const idx = Math.round(-top/100);
    const children = reel.list.children;
    for(let row=0; row<3; row++){
      const img = children[idx+row]?.querySelector("img");
      lines[row][col] = img?.alt || "";
    }
  });
  return lines;
}

function checkWin() {
  const v = visibleSymbols();
  const resultBox = document.getElementById("result");
  resultBox.textContent = "";
  
  let totalWin = 0;
  let highlightRows = [];

  for (let row = 0; row < 3; row++) {
    const line = v[row];
    for (let s=0;s<=2;s++){
      const sym = line[s];
      let count=1;
      for(let i=s+1;i<5&& line[i]===sym;i++) count++;
      
      if(count>=3){
        if(sym==="orb"){
          bonusMode = true;
          break;
        }
        const pay = payout[sym]?.[count] ?? 0;
        totalWin += pay;
        highlightRows.push(row);
        break;
      }
    }
  }

  if (bonusMode) {
    resultBox.textContent = "ボーナスモード突入！！";
    bgmNormal.pause();
    bgmBonus.currentTime = 0;
    bgmBonus.play();
    dropCoins(50);
    setTimeout(() => startBonus(), 800);
    return;
  }

  if(totalWin > 0){
    resultBox.textContent = `${totalWin}pt 獲得！`;
    dropCoins(60);

    const max = Math.max(...highlightRows);
    if(max===2) win5Sound.play();
    else if(max===1) win4Sound.play();
    else win3Sound.play();

    updatePoints(totalWin);
    updatePointDisplay();

    highlightRows.forEach(row=>{
      [...slotContainer.children].forEach((reelDiv,col)=>{
        const reel = reelDiv.querySelector(".symbols");
        const top = parseFloat(reel.style.top)||0;
        const idx = Math.round(-top/100);
        const target = reel.children[idx+row];
        if(target) target.classList.add("highlight");
      });
    });

  } else {
    resultBox.textContent = "ハズレ…";
    loseSound.play();
  }
}

/* ==========================================================
    BONUS SPIN
========================================================== */
function startBonus() {
  setupReels();
  checking = false;
  spinning = Array(reelCount).fill(true);

  reels.forEach((_,i)=> spinReel(i));

  setTimeout(()=>{
    spinning=Array(reelCount).fill(false);
    setTimeout(()=>{
      bonusMode=false;
      bgmBonus.pause();
      bgmNormal.currentTime=0;
      bgmNormal.play();
      checkWin();
    },1200);
  },1500);
}

/* ==========================================================
    START
========================================================== */
document.getElementById("start").addEventListener("click", async ()=>{
  const p = await getPoints();
  if ((p.points??0) < 10) {
    document.getElementById("result").textContent="ポイント不足！（必要：10）";
    return;
  }

  await updatePoints(-10);
  updatePointDisplay();
  startSound.play();

  bonusMode=false;
  bgmBonus.pause();
  bgmNormal.play();

  setupReels();
  checking=false;
  spinning=Array(reelCount).fill(true);
  reels.forEach((_,i)=>spinReel(i));

  setTimeout(()=>{
    spinning=Array(reelCount).fill(false);
    setTimeout(()=> checkWin(), 600);
  },1400);
});

/* ==========================================================
    ポイント表示更新
========================================================== */
async function updatePointDisplay(){
  const p = await getPoints();
  document.getElementById("points").textContent = p.points ?? 0;
}

/* ==========================================================
    初期化
========================================================== */
setupReels();

</script>

</body>
</html>
