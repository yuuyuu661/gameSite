<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>Slot Machine</title>

<style>
  body {
    background: #0c1b2a;
    color: white;
    font-family: sans-serif;
    text-align: center;
    margin: 0;
    padding: 0;
  }

  /* ペイテーブル */
  #payoutTable {
    width: 90%;
    max-width: 700px;
    margin: 20px auto 0 auto;
    display: block;
    border: 2px solid gold;
    border-radius: 12px;
    box-shadow: 0 0 12px rgba(255, 215, 0, 0.5);
  }

  #slot-container {
    margin-top: 25px;
    display: flex;
    justify-content: center;
    gap: 10px;
  }

  /* STOP ボタン付きの１リール */
  .reel-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .reel {
    width: 120px;
    height: 300px;
    overflow: hidden;
    background: #111;
    border: 3px solid gold;
    border-radius: 10px;
  }

  .symbols {
    position: relative;
    top: 0;
    width: 100%;
  }

  .symbol {
    height: 100px;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .symbol.highlight {
    border: 2px solid yellow;
    border-radius: 8px;
    background: rgba(255,255,0,0.25);
  }

  .stop-btn {
    margin-top: 5px;
    padding: 6px 12px;
    font-size: 14px;
  }

  #start {
    font-size: 24px;
    margin-top: 25px;
    padding: 10px 25px;
  }

  #points-box {
    margin-top: 15px;
    font-size: 18px;
  }

  .coin {
    position: fixed;
    top: -60px;
    width: 40px;
    height: 40px;
    pointer-events: none;
    animation: fall 1.5s linear forwards;
    z-index: 1000;
  }

  @keyframes fall {
    to {
      top: 100%;
      transform: rotate(360deg);
      opacity: 0;
    }
  }
</style>
</head>
<body>

<a href="/" class="back-btn" style="margin:10px;display:inline-block;padding:8px 14px;background:#333;border-radius:8px;color:white;text-decoration:none;">← メニューへ戻る</a>

<!-- ▼ ペイテーブル -->
<img src="images/payout_table.png" id="payoutTable">

<!-- ▼ スロット全体（STOPつき） -->
<div id="slot-container"></div>

<!-- ▼ スタート -->
<button id="start">スタート！</button>

<!-- ▼ ポイント表示 -->
<div id="points-box">
  所持ポイント：<span id="points">0</span>
</div>

<!-- ▼ 音量 -->
<div style="margin-top:12px;">
  BGM 音量：<input type="range" id="volume-slider" min="0" max="100" value="80">
</div>

<div id="result" style="margin-top:20px;font-size:20px;"></div>

<!-- ▼ 全サウンド -->
<audio id="bgmNormal" src="sounds/bgm_normal.mp3" loop></audio>
<audio id="bgmBonus"  src="sounds/bgm_bonus.mp3" loop></audio>
<audio id="startSound" src="sounds/start.mp3"></audio>
<audio id="stopSound"  src="sounds/stop.mp3"></audio>
<audio id="win3Sound"  src="sounds/win3.mp3"></audio>
<audio id="win4Sound"  src="sounds/win4.mp3"></audio>
<audio id="win5Sound"  src="sounds/win5.mp3"></audio>
<audio id="loseSound"  src="sounds/lose.mp3"></audio>

<script type="module">

/* ▼ ミニゲーム側API読込 */
import { getDisplayName, getPoints, updatePoints } from "/js/common.js";

/* =====================================================
    初期設定
===================================================== */
let displayName = getDisplayName();
let pointsData = await getPoints();
let points = pointsData.points ?? 0;

document.getElementById("points").textContent = points;

const slotContainer = document.getElementById("slot-container");

const bgmNormal = document.getElementById("bgmNormal");
const bgmBonus  = document.getElementById("bgmBonus");
const startSound = document.getElementById("startSound");
const stopSound  = document.getElementById("stopSound");
const win3Sound  = document.getElementById("win3Sound");
const win4Sound  = document.getElementById("win4Sound");
const win5Sound  = document.getElementById("win5Sound");
const loseSound  = document.getElementById("loseSound");

/* 音量初期設定 */
function applyVolume(v){
  bgmNormal.volume = v;
  bgmBonus.volume  = v;
  startSound.volume = v;
  stopSound.volume  = v;
  win3Sound.volume  = v;
  win4Sound.volume  = v;
  win5Sound.volume  = v;
  loseSound.volume  = v;
}
applyVolume(0.8);

document.getElementById("volume-slider").addEventListener("input", e=>{
  applyVolume(e.target.value / 100);
});

bgmNormal.play().catch(()=>{});

/* =====================================================
    スロット設定
===================================================== */
const reelCount = 5;
const rowsVisible = 3;

const reelData = [
  { name:"seven", src:"images/seven.png" },
  { name:"orb",   src:"images/orb.png" },
  { name:"slime", src:"images/slime.png" },
  { name:"lemon", src:"images/lemon.png" },
  { name:"grape", src:"images/grape.png" },
  { name:"bell",  src:"images/bell.png" },
  { name:"gem",   src:"images/gem.png" }
];

const weights = [6,6,10,12,18,20,28];

const payout = {
  seven:{3:50,4:250,5:500},
  gem:{3:30,4:150,5:300},
  bell:{3:10,4:50,5:100},
  grape:{3:5,4:25,5:50},
  lemon:{3:3,4:15,5:30},
  slime:{3:2,4:10,5:20},
  orb:{3:0,4:0,5:0}
};

function randSymbol(){
  const total = weights.reduce((a,b)=>a+b);
  let r = Math.random()*total;
  for(let i=0;i<weights.length;i++){
    r -= weights[i];
    if(r<0) return reelData[i];
  }
  return reelData.at(-1);
}

/* =====================================================
    ペイテーブル切替
===================================================== */
function setBonusPaytable(bonus){
  const pt = document.getElementById("payoutTable");
  pt.src = bonus ? "images/payout_table_bonus.png"
                 : "images/payout_table.png";
}

/* =====================================================
    コイン降下演出
===================================================== */
function dropCoins(count=40){
  for(let i=0;i<count;i++){
    const c = document.createElement("img");
    c.src = "images/coin.png";
    c.className = "coin";
    c.style.left = Math.random()*window.innerWidth+"px";
    document.body.appendChild(c);
    setTimeout(()=>c.remove(),2000);
  }
}

/* =====================================================
    リール生成（STOPボタン付き）
===================================================== */
let reels = [];
let spinningFlags = [];
let inBonus = false;
let bonusSpins = 0;
let hasChecked = false;

function setupReels(){
  slotContainer.innerHTML = "";
  reels = [];

  for(let i=0;i<reelCount;i++){
    const wrap = document.createElement("div");
    wrap.className="reel-wrapper";

    const reel = document.createElement("div");
    reel.className = "reel";

    const list = document.createElement("div");
    list.className="symbols";

    for(let k=0;k<20;k++){
      const sym = randSymbol();
      const div = document.createElement("div");
      div.className="symbol";
      const img=document.createElement("img");
      img.src = inBonus && sym.name!=="orb"
        ? sym.src.replace(".png","_bonus.png")
        : sym.src;
      img.alt = sym.name;
      img.style.width="80px";
      img.style.height="80px";
      div.appendChild(img);
      list.appendChild(div);
    }

    reel.appendChild(list);
    wrap.appendChild(reel);

    /* STOPボタン */
    const stopBtn = document.createElement("button");
    stopBtn.className="stop-btn";
    stopBtn.textContent="STOP";
    stopBtn.dataset.index=i;
    stopBtn.addEventListener("click",()=>stopReel(i));
    wrap.appendChild(stopBtn);

    slotContainer.appendChild(wrap);
    reels.push({reel,list,pos:0,speed: inBonus?35:20 });
  }
}

/* =====================================================
    リール回転
===================================================== */
function spinReel(i){
  const obj = reels[i];
  function anim(){
    obj.pos += obj.speed;

    if(obj.pos>=100){
      const sym = randSymbol();
      const div=document.createElement("div");
      div.className="symbol";
      const img=document.createElement("img");
      img.src = inBonus && sym.name!=="orb"
        ? sym.src.replace(".png","_bonus.png")
        : sym.src;
      img.alt=sym.name;
      img.style.width="80px";
      img.style.height="80px";
      div.appendChild(img);

      obj.list.appendChild(div);
      obj.list.removeChild(obj.list.firstElementChild);
      obj.pos-=100;
    }

    obj.list.style.top = -obj.pos+"px";

    if(!spinningFlags[i]){
      obj.speed*=0.92;
      if(obj.speed<=1){
        const snap=Math.round(obj.pos/100)*100;
        obj.list.style.top = -snap+"px";
        return;
      }
    }

    requestAnimationFrame(anim);
  }
  requestAnimationFrame(anim);
}

/* =====================================================
    STOP 処理
===================================================== */
function stopReel(index){
  stopSound.currentTime=0;
  stopSound.play();

  spinningFlags[index]=false;

  if(spinningFlags.every(f=>!f) && !hasChecked){
    hasChecked = true;

    setTimeout(()=>{

      checkWin();

      if(bonusSpins>0) bonusSpins--;

      if(bonusSpins<=0 && inBonus){
        inBonus=false;
        bgmBonus.pause();
        bgmNormal.currentTime=0;
        bgmNormal.play();
        setBonusPaytable(false);
        alert("ボーナスタイム終了！");
      }

    },600);
  }
}

/* =====================================================
    当たり判定
===================================================== */
function getVisible(){
  const rows=[[],[],[]];
  reels.forEach((r,col)=>{
    const top=parseFloat(r.list.style.top)||0;
    const idx=Math.round(-top/100);
    for(let row=0;row<3;row++){
      const el=r.list.children[idx+row];
      rows[row][col]=el?.querySelector("img")?.alt||"";
    }
  });
  return rows;
}

async function checkWin(){
  const v=getVisible();
  const result=document.getElementById("result");
  result.textContent="";

  let totalWin=0;
  let highlightList=[];
  let orbCount=0;

  for(let row=0;row<3;row++){
    const line=v[row];
    for(let s=0;s<=2;s++){
      const sym=line[s];
      let count=1;
      for(let i=s+1;i<5 && line[i]==sym;i++) count++;

      if(count>=3){
        const pay=payout[sym]?.[count]??0;
        totalWin+=pay;

        if(sym==="orb"){
          orbCount=count;
        }

        for(let i=s;i<s+count;i++){
          highlightList.push({row,col:i});
        }
        break;
      }
    }
  }

  highlightList.forEach(({row,col})=>{
    const r=reels[col];
    const top=parseFloat(r.list.style.top)||0;
    const idx=Math.round(-top/100);
    const el=r.list.children[idx+row];
    if(el) el.classList.add("highlight");
  });

  if(orbCount>=3 && !inBonus){
    inBonus=true;
    bonusSpins=orbCount;
    bgmNormal.pause();
    bgmBonus.currentTime=0;
    bgmBonus.play();
    setBonusPaytable(true);
    dropCoins(80);
    alert("ボーナスタイム開始！ ×"+bonusSpins);
    return;
  }

  if(totalWin>0){
    dropCoins(60);

    if(totalWin>=500) win5Sound.play();
    else if(totalWin>=100) win4Sound.play();
    else win3Sound.play();

    result.textContent = totalWin + "pt 獲得！";

    await updatePoints(totalWin);
    const p=await getPoints();
    document.getElementById("points").textContent=p.points;

  } else {
    loseSound.play();
    result.textContent="ハズレ…";
  }
}

/* =====================================================
    START
===================================================== */
document.getElementById("start").addEventListener("click",async()=>{

  const p=await getPoints();
  if(!inBonus && (p.points??0)<10){
    document.getElementById("result").textContent="ポイント不足！（必要：10）";
    return;
  }

  if(!inBonus){
    await updatePoints(-10);
    const np=await getPoints();
    document.getElementById("points").textContent=np.points;
  }

  startSound.currentTime=0;
  startSound.play();

  hasChecked=false;
  setupReels();

  spinningFlags=Array(reelCount).fill(true);
  reels.forEach((_,i)=>spinReel(i));
});
// ▼ スマホの自動再生制限対策
document.body.addEventListener(
  "touchstart",
  () => {
    bgmNormal.play().catch(() => {});
  },
  { once: true }
);

// PC 対策（クリック）
document.body.addEventListener(
  "click",
  () => {
    bgmNormal.play().catch(() => {});
  },
  { once: true }
);

/* =====================================================
    初期化
===================================================== */
setupReels();

</script>
</body>
</html>

