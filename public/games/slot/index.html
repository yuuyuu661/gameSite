<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>スロットマシン</title>

<style>
  body {
    font-family: sans-serif;
    text-align: center;
    background-color: #0c1b2a;
    color: #fff;
  }
  .top-menu {
    margin-top: 15px;
    margin-bottom: 10px;
  }
  .top-menu a {
    color: #fff;
    text-decoration: none;
    background: #444;
    padding: 8px 14px;
    border-radius: 8px;
    border: 1px solid #888;
  }
  .slot-container {
    display: flex;
    justify-content: center;
    margin-top: 20px;
    overflow: hidden;
    width: 650px;
    height: 400px;
    margin-left: auto;
    margin-right: auto;
  }
  .reel-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin: 0 2px;
  }
  .reel {
    width: 100px;
    height: 400px;
    overflow: hidden;
    background: #222;
    border: 3px solid gold;
    box-shadow: 0 0 10px gold;
  }
  .symbols {
    position: relative;
    top: 0;
    width: 100%;
  }
  .symbol {
    height: 100px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  #start {
    font-size: 24px;
    margin-top: 20px;
  }
  #pointsDisplay {
    margin-top: 20px;
    font-size: 18px;
  }
</style>
</head>

<body>

<div class="top-menu">
  <a href="/">← メニューへ戻る</a>
</div>

<img src="images/payout_table.png" id="payoutTable">

<div class="slot-container" id="slotContainer"></div>

<button id="start">スタート！</button>

<div id="pointsDisplay">
  所持ポイント: <span id="points">0</span>
</div>

<div id="result"></div>

<script type="module">
import { getDisplayName, getPoints, updatePoints } from "/js/common.js";

/* ==========================================================
      表示名 / ポイントの読み込み（C案 対応版）
========================================================== */

let displayName = null;
let points = 0;

window.addEventListener("DOMContentLoaded", async () => {
  displayName = getDisplayName();

  if (!displayName) {
    alert("メニューでプレイヤー名を設定してください");
    location.href = "/";
    return;
  }

  const p = await getPoints();
  points = p.points ?? 0;
  document.getElementById("points").textContent = points;
});


/* ==========================================================
      スロット本体
========================================================== */

const symbols = [
  { name: "seven", src: "images/seven.png" },
  { name: "orb", src: "images/orb.png" },
  { name: "slime", src: "images/slime.png" },
  { name: "lemon", src: "images/lemon.png" },
  { name: "grape", src: "images/grape.png" },
  { name: "bell", src: "images/bell.png" },
  { name: "gem", src: "images/gem.png" }
];

const symbolWeights = [6, 6, 10, 12, 18, 20, 28];

const payoutTable = {
  "seven": { 3: 50, 4: 250, 5: 500 },
  "gem":   { 3: 30, 4: 150, 5: 300 },
  "bell":  { 3: 10, 4: 50,  5: 100 },
  "grape": { 3: 5,  4: 25,  5: 50  },
  "lemon": { 3: 3,  4: 15,  5: 30  },
  "slime": { 3: 2,  4: 10,  5: 20  }
};

const reels = [];
const reelCount = 5;
const rowsVisible = 3;

const resultEl = document.getElementById("result");
const startBtn = document.getElementById("start");
const slotContainer = document.getElementById("slotContainer");

let spinningFlags = [];
let hasChecked = false;

// ===== ランダムシンボル =====
function getRandomSymbol() {
  const total = symbolWeights.reduce((a,b)=>a+b);
  let rand = Math.random() * total, acc = 0;
  for (let i = 0; i < symbols.length; i++) {
    acc += symbolWeights[i];
    if (rand < acc) return symbols[i];
  }
  return symbols[symbols.length - 1];
}

function createSymbolDiv(symbol) {
  const div = document.createElement("div");
  div.className = "symbol";
  const img = document.createElement("img");
  img.src = symbol.src;
  img.alt = symbol.name;
  img.style.width = "80px";
  img.style.height = "80px";
  div.appendChild(img);
  return div;
}

// ===== リールセットアップ =====
for (let i = 0; i < reelCount; i++) {
  const wrapper = document.createElement("div");
  wrapper.className = "reel-wrapper";

  const reel = document.createElement("div");
  reel.className = "reel";

  const symbolsDiv = document.createElement("div");
  symbolsDiv.className = "symbols";
  reel.appendChild(symbolsDiv);
  wrapper.appendChild(reel);

  const btn = document.createElement("button");
  btn.className = "stop-btn";
  btn.textContent = "STOP";
  btn.dataset.index = i;
  wrapper.appendChild(btn);

  slotContainer.appendChild(wrapper);
  reels.push(reel);
}

function setupReels() {
  reels.forEach(reel => {
    const container = reel.querySelector(".symbols");
    container.innerHTML = "";
    for (let i = 0; i < 20; i++) {
      container.appendChild(createSymbolDiv(getRandomSymbol()));
    }
    container.style.top = "0px";
  });
}

// ===== 回転 =====
function startReel(i) {
  const container = reels[i].querySelector(".symbols");
  let pos = 0, speed = 20, slowing = false;

  function anim() {
    pos += speed;

    if (pos >= 100) {
      container.appendChild(createSymbolDiv(getRandomSymbol()));
      container.removeChild(container.firstElementChild);
      pos -= 100;
    }

    container.style.top = -pos + "px";

    if (!spinningFlags[i]) {
      if (!slowing) slowing = true;
      speed *= 0.92;
      if (speed <= 1) {
        const align = Math.round(pos / 100) * 100;
        container.style.top = -align + "px";
        return;
      }
    }

    requestAnimationFrame(anim);
  }

  requestAnimationFrame(anim);
}

// ===== STOP =====
document.querySelectorAll(".stop-btn").forEach(btn=>{
  btn.addEventListener("click", ()=> stopReel(+btn.dataset.index));
});

function stopReel(i) {
  spinningFlags[i] = false;

  if (spinningFlags.every(f=>!f) && !hasChecked) {
    hasChecked = true;
    setTimeout(checkWin, 400);
  }
}

// ===== 判定 =====
function getVisibleSymbols() {
  const visible = [[],[],[]];

  reels.forEach((reel, col)=>{
    const container = reel.querySelector(".symbols");
    const top = parseFloat(container.style.top) || 0;
    const offset = Math.round(-top / 100);
    const els = container.children;

    for (let row=0; row<rowsVisible; row++) {
      visible[row][col] =
        els[offset + row]?.querySelector("img")?.alt || "";
    }
  });

  return visible;
}

function checkWin() {
  const visible = getVisibleSymbols();
  const results = [];
  let totalWin = 0;

  visible.forEach((line, row)=>{
    for(let s=0;s<=2;s++){
      const sym = line[s];
      let count=1;
      for(let i=s+1;i<5 && line[i]===sym;i++) count++;

      if(count >= 3){
        results.push({ row, symbol:sym, count });
        totalWin += payoutTable[sym]?.[count] || 0;
        break;
      }
    }
  });

  if(totalWin > 0){
    resultEl.textContent =
      results.map(r =>
        `「${["上","中","下"][r.row]}段:${r.symbol}×${r.count}」`
      ).join(" / ") + `（${totalWin}pt）`;

    updatePoints(totalWin);

    setTimeout(async ()=>{
      const p = await getPoints();
      document.getElementById("points").textContent = p.points;
    }, 300);

  } else {
    resultEl.textContent = "ハズレ…";
  }
}

// ===== スタート =====
startBtn.addEventListener("click", async ()=>{
  const p = await getPoints();
  points = p.points || 0;

  if (points < 10) {
    resultEl.textContent = "ポイント不足です（10pt必要）";
    return;
  }

  await updatePoints(-10);
  document.getElementById("points").textContent = points - 10;

  resultEl.textContent = "";
  hasChecked = false;
  spinningFlags = Array(reelCount).fill(true);

  setupReels();
  for(let i=0;i<reelCount;i++) startReel(i);
});

// 初期化
setupReels();
</script>

</body>
</html>
