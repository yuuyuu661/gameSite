<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>ポケモンフュージョンクイズ</title>
  <link rel="stylesheet" href="/style.css" />

  <script type="module">
    import { submitScore } from "/js/common.js";

    // ★ここに「参考サイトからコピペした画像URL」と「元ポケモン名」を登録してください
    const FUSIONS = [
      {
        id: 1,
        image: "https://images.alexonsager.net/pokemon/fused/25/25.54.png",
        left: "ピカチュウ",
        right: "コダック",
      },
      {
        id: 2,
        image: "https://images.alexonsager.net/pokemon/fused/1/1.7.png",
        left: "フシギダネ",
        right: "ゼニガメ",
      },
      {
        id: 3,
        image: "https://images.alexonsager.net/pokemon/fused/4/4.39.png",
        left: "ヒトカゲ",
        right: "プリン",
      },
     { id: 4,   image: "", left: "", right: "" },
     { id: 5,   image: "", left: "", right: "" },
     { id: 6,   image: "", left: "", right: "" },
     { id: 7,   image: "", left: "", right: "" },
     { id: 8,   image: "", left: "", right: "" },
     { id: 9,   image: "", left: "", right: "" },
     { id: 10,   image: "", left: "", right: "" },
     { id: 11,   image: "", left: "", right: "" },
     { id: 12,   image: "", left: "", right: "" },
     { id: 13,   image: "", left: "", right: "" },
     { id: 14,   image: "", left: "", right: "" },
     { id: 15,   image: "", left: "", right: "" },
     { id: 16,   image: "", left: "", right: "" },
     { id: 17,   image: "", left: "", right: "" },
     { id: 18,   image: "", left: "", right: "" },
     { id: 19,   image: "", left: "", right: "" },
     { id: 20,   image: "", left: "", right: "" },
     { id: 21,   image: "", left: "", right: "" },
     { id: 22,   image: "", left: "", right: "" },
     { id: 23,   image: "", left: "", right: "" },
     { id: 24,   image: "", left: "", right: "" },
     { id: 25,   image: "", left: "", right: "" },
     { id: 26,   image: "", left: "", right: "" },
     { id: 27,   image: "", left: "", right: "" },
     { id: 28,   image: "", left: "", right: "" },
     { id: 29,   image: "", left: "", right: "" },
     { id: 30,   image: "", left: "", right: "" },
     { id: 31,   image: "", left: "", right: "" },
     { id: 32,   image: "", left: "", right: "" },
     { id: 33,   image: "", left: "", right: "" },
     { id: 34,   image: "", left: "", right: "" },
     { id: 35,   image: "", left: "", right: "" },
     { id: 36,   image: "", left: "", right: "" },
     { id: 37,   image: "", left: "", right: "" },
     { id: 38,   image: "", left: "", right: "" },
     { id: 39,   image: "", left: "", right: "" },
     { id: 40,   image: "", left: "", right: "" },
     { id: 41,   image: "", left: "", right: "" },
     { id: 42,   image: "", left: "", right: "" },
     { id: 43,   image: "", left: "", right: "" },
     { id: 44,   image: "", left: "", right: "" },
     { id: 45,   image: "", left: "", right: "" },
     { id: 46,   image: "", left: "", right: "" },
     { id: 47,   image: "", left: "", right: "" },
     { id: 48,   image: "", left: "", right: "" },
     { id: 49,   image: "", left: "", right: "" },
     { id: 50,   image: "", left: "", right: "" },
     { id: 51,   image: "", left: "", right: "" },
     { id: 52,   image: "", left: "", right: "" },
     { id: 53,   image: "", left: "", right: "" },
     { id: 54,   image: "", left: "", right: "" },
     { id: 55,   image: "", left: "", right: "" },
     { id: 56,   image: "", left: "", right: "" },
     { id: 57,   image: "", left: "", right: "" },
     { id: 58,   image: "", left: "", right: "" },
     { id: 59,   image: "", left: "", right: "" },
     { id: 60,   image: "", left: "", right: "" },
     { id: 61,   image: "", left: "", right: "" },
     { id: 62,   image: "", left: "", right: "" },
     { id: 63,   image: "", left: "", right: "" },
     { id: 64,   image: "", left: "", right: "" },
     { id: 65,   image: "", left: "", right: "" },
     { id: 66,   image: "", left: "", right: "" },
     { id: 67,   image: "", left: "", right: "" },
     { id: 68,   image: "", left: "", right: "" },
     { id: 69,   image: "", left: "", right: "" },
     { id: 70,   image: "", left: "", right: "" },
     { id: 71,   image: "", left: "", right: "" },
     { id: 72,   image: "", left: "", right: "" },
     { id: 73,   image: "", left: "", right: "" },
     { id: 74,   image: "", left: "", right: "" },
     { id: 75,   image: "", left: "", right: "" },
     { id: 76,   image: "", left: "", right: "" },
     { id: 77,   image: "", left: "", right: "" },
     { id: 78,   image: "", left: "", right: "" },
     { id: 79,   image: "", left: "", right: "" },
     { id: 80,   image: "", left: "", right: "" },
     { id: 81,   image: "", left: "", right: "" },
     { id: 82,   image: "", left: "", right: "" },
     { id: 83,   image: "", left: "", right: "" },
     { id: 84,   image: "", left: "", right: "" },
     { id: 85,   image: "", left: "", right: "" },
     { id: 86,   image: "", left: "", right: "" },
     { id: 87,   image: "", left: "", right: "" },
     { id: 88,   image: "", left: "", right: "" },
     { id: 89,   image: "", left: "", right: "" },
     { id: 90,   image: "", left: "", right: "" },
     { id: 91,   image: "", left: "", right: "" },
     { id: 92,   image: "", left: "", right: "" },
     { id: 93,   image: "", left: "", right: "" },
     { id: 84,   image: "", left: "", right: "" },
     { id: 85,   image: "", left: "", right: "" },
     { id: 86,   image: "", left: "", right: "" },
     { id: 87,   image: "", left: "", right: "" },
     { id: 88,   image: "", left: "", right: "" },
     { id: 89,   image: "", left: "", right: "" },
     { id: 90,   image: "", left: "", right: "" },
     { id: 91,   image: "", left: "", right: "" },
     { id: 92,   image: "", left: "", right: "" },
     { id: 93,   image: "", left: "", right: "" },
     { id: 94,   image: "", left: "", right: "" },
     { id: 95,   image: "", left: "", right: "" },
     { id: 96,   image: "", left: "", right: "" },
     { id: 97,   image: "", left: "", right: "" },
     { id: 98,   image: "", left: "", right: "" },
     { id: 99,   image: "", left: "", right: "" },
     { id: 100,   image: "", left: "", right: "" },
     { id: 101,   image: "", left: "", right: "" },
     { id: 102,   image: "", left: "", right: "" },
     { id: 103,   image: "", left: "", right: "" },
     { id: 104,   image: "", left: "", right: "" },
     { id: 105,   image: "", left: "", right: "" },
     { id: 106,   image: "", left: "", right: "" },
     { id: 107,   image: "", left: "", right: "" },
     { id: 108,   image: "", left: "", right: "" },
     { id: 109,   image: "", left: "", right: "" },
     { id: 110,   image: "", left: "", right: "" },
     { id: 111,   image: "", left: "", right: "" },
     { id: 112,   image: "", left: "", right: "" },
     { id: 113,   image: "", left: "", right: "" },
     { id: 114,   image: "", left: "", right: "" },
     { id: 115,   image: "", left: "", right: "" },
     { id: 116,   image: "", left: "", right: "" },
     { id: 117,   image: "", left: "", right: "" },
     { id: 118,   image: "", left: "", right: "" },
     { id: 119,   image: "", left: "", right: "" },
     { id: 120,   image: "", left: "", right: "" },
     { id: 121,   image: "", left: "", right: "" },
     { id: 122,   image: "", left: "", right: "" },
     { id: 123,   image: "", left: "", right: "" },
     { id: 124,   image: "", left: "", right: "" },
     { id: 125,   image: "", left: "", right: "" },
     { id: 126,   image: "", left: "", right: "" },
     { id: 127,   image: "", left: "", right: "" },
     { id: 128,   image: "", left: "", right: "" },
     { id: 129,   image: "", left: "", right: "" },
     { id: 130,   image: "", left: "", right: "" },
     { id: 131,   image: "", left: "", right: "" },
     { id: 132,   image: "", left: "", right: "" },
     { id: 133,   image: "", left: "", right: "" },
     { id: 134,   image: "", left: "", right: "" },
     { id: 135,   image: "", left: "", right: "" },
     { id: 136,   image: "", left: "", right: "" },
     { id: 137,   image: "", left: "", right: "" },
     { id: 138,   image: "", left: "", right: "" },
     { id: 139,   image: "", left: "", right: "" },
     { id: 140,   image: "", left: "", right: "" },
     { id: 141,   image: "", left: "", right: "" },
     { id: 142,   image: "", left: "", right: "" },
     { id: 143,   image: "", left: "", right: "" },
     { id: 144,   image: "", left: "", right: "" },
     { id: 145,   image: "", left: "", right: "" },
     { id: 146,   image: "", left: "", right: "" },
     { id: 147,   image: "", left: "", right: "" },
     { id: 148,   image: "", left: "", right: "" },
     { id: 149,   image: "", left: "", right: "" },
     { id: 150,   image: "", left: "", right: "" },
     { id: 151,   image: "", left: "", right: "" },
     { id: 152,   image: "", left: "", right: "" },
     { id: 153,   image: "", left: "", right: "" },
     { id: 154,   image: "", left: "", right: "" },
     { id: 155,   image: "", left: "", right: "" },
     { id: 156,   image: "", left: "", right: "" },
     { id: 157,   image: "", left: "", right: "" },
     { id: 158,   image: "", left: "", right: "" },
     { id: 159,   image: "", left: "", right: "" },
     { id: 160,   image: "", left: "", right: "" },
     { id: 161,   image: "", left: "", right: "" },
     { id: 162,   image: "", left: "", right: "" },
     { id: 163,   image: "", left: "", right: "" },
     { id: 164,   image: "", left: "", right: "" },
     { id: 165,   image: "", left: "", right: "" },
     { id: 166,   image: "", left: "", right: "" },
     { id: 167,   image: "", left: "", right: "" },
     { id: 168,   image: "", left: "", right: "" },
     { id: 169,   image: "", left: "", right: "" },
     { id: 170,   image: "", left: "", right: "" },
     { id: 171,   image: "", left: "", right: "" },
     { id: 172,   image: "", left: "", right: "" },
     { id: 173,   image: "", left: "", right: "" },
     { id: 174,   image: "", left: "", right: "" },
     { id: 175,   image: "", left: "", right: "" },
     { id: 176,   image: "", left: "", right: "" },
     { id: 177,   image: "", left: "", right: "" },
     { id: 178,   image: "", left: "", right: "" },
     { id: 179,   image: "", left: "", right: "" },
     { id: 180,   image: "", left: "", right: "" },
     { id: 181,   image: "", left: "", right: "" },
     { id: 182,   image: "", left: "", right: "" },
     { id: 183,   image: "", left: "", right: "" },
     { id: 184,   image: "", left: "", right: "" },
     { id: 185,   image: "", left: "", right: "" },
     { id: 186,   image: "", left: "", right: "" },
     { id: 187,   image: "", left: "", right: "" },
     { id: 188,   image: "", left: "", right: "" },
     { id: 189,   image: "", left: "", right: "" },
     { id: 190,   image: "", left: "", right: "" },
     { id: 191,   image: "", left: "", right: "" },
     { id: 192,   image: "", left: "", right: "" },
     { id: 193,   image: "", left: "", right: "" },
     { id: 194,   image: "", left: "", right: "" },
     { id: 195,   image: "", left: "", right: "" },
     { id: 196,   image: "", left: "", right: "" },
     { id: 197,   image: "", left: "", right: "" },
     { id: 198,   image: "", left: "", right: "" },
     { id: 199,   image: "", left: "", right: "" },
     { id: 200,   image: "", left: "", right: "" },
      // 好きなだけ追加OK
    ];

    let current = null;
    let score = 0;
    let correctCount = 0;
    let askedCount = 0;
    let timeLeft = 180; // ★ 3分
    let timerId = null;

    function normalize(str) {
      return (str || "").replace(/\s+/g, "").toLowerCase();
    }

    function pickNext() {
      if (!FUSIONS.length) return null;
      const idx = Math.floor(Math.random() * FUSIONS.length);
      return FUSIONS[idx];
    }

    function showQuestion() {
      const q = pickNext();
      const img = document.getElementById("fusion-image");
      const ans1 = document.getElementById("ans1");
      const ans2 = document.getElementById("ans2");
      const feedback = document.getElementById("feedback");

      if (!q) {
        feedback.textContent =
          "問題が設定されていません。FUSIONS 配列を編集してください。";
        img.src = "";
        return;
      }

      current = q;
      askedCount++;

      img.src = q.image;
      img.alt = "fusion #" + q.id;
      ans1.value = "";
      ans2.value = "";
      feedback.textContent = "";
    }

    function checkAnswer() {
      if (!current) return;
      const a1 = normalize(document.getElementById("ans1").value);
      const a2 = normalize(document.getElementById("ans2").value);
      const answers = [a1, a2];

      const left = normalize(current.left);
      const right = normalize(current.right);
      const correctSet = [left, right];

      // ★順不同OK
      const ok =
        answers.includes(correctSet[0]) && answers.includes(correctSet[1]);

      const feedback = document.getElementById("feedback");
      if (ok) {
        correctCount++;
        score += 100;
        feedback.textContent = `正解！ +100（正解 ${correctCount}問）`;
      } else {
        feedback.textContent = `ざんねん… 正解は「${current.left} × ${current.right}」`;
      }

      document.getElementById("score").textContent = score;
      showQuestion();
    }

    function passQuestion() {
      const feedback = document.getElementById("feedback");
      if (current) {
        feedback.textContent = `パスしました。正解は「${current.left} × ${current.right}」`;
      } else {
        feedback.textContent = "パスしました。";
      }
      showQuestion();
    }

    async function finishGame() {
      if (timerId) {
        clearInterval(timerId);
        timerId = null;
      }
      const controls = document.getElementById("controls");
      controls.style.pointerEvents = "none";
      controls.style.opacity = "0.6";

      const summary = `終了！ 正解 ${correctCount}問 / 出題 ${askedCount}問 / スコア ${score}`;
      document.getElementById("feedback").textContent = summary;

      const info = document.getElementById("result-info");
      try {
        const res = await submitScore("fusion", score, {
          correct: correctCount,
          total: askedCount,
        });
        if (res && res.ok !== false) {
          info.textContent = `サーバー送信完了：+${res.addedPoints ?? 0}pt（合計 ${
            res.totalPoints ?? "?"
          }pt）`;
        } else {
          info.textContent = "スコア送信に失敗しました。";
        }
      } catch (e) {
        console.error(e);
        info.textContent = "スコア送信に失敗しました。";
      }
    }

    function startGame() {
      if (!FUSIONS.length) {
        alert("問題が未設定です。FUSIONS 配列を編集してください。");
        return;
      }

      score = 0;
      correctCount = 0;
      askedCount = 0;
      timeLeft = 180; // ★ 3分

      document.getElementById("score").textContent = score;
      document.getElementById("time").textContent = timeLeft;
      document.getElementById("feedback").textContent = "";
      document.getElementById("result-info").textContent = "";

      const controls = document.getElementById("controls");
      controls.style.pointerEvents = "auto";
      controls.style.opacity = "1";

      if (timerId) clearInterval(timerId);
      timerId = setInterval(() => {
        timeLeft--;
        document.getElementById("time").textContent = timeLeft;
        if (timeLeft <= 0) {
          finishGame();
        }
      }, 1000);

      showQuestion();
    }

    document.addEventListener("DOMContentLoaded", () => {
      document
        .getElementById("start-btn")
        .addEventListener("click", startGame);
      document
        .getElementById("submit-btn")
        .addEventListener("click", checkAnswer);
      document
        .getElementById("pass-btn")
        .addEventListener("click", passQuestion);
    });
  </script>

  <script>
    // ダブルタップ拡大防止（他ページと同じ）
    let __lastTouchEnd = 0;
    document.addEventListener(
      "touchend",
      function (e) {
        const now = Date.now();
        if (now - __lastTouchEnd <= 300) {
          e.preventDefault();
        }
        __lastTouchEnd = now;
      },
      { passive: false }
    );
  </script>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ポケモンフュージョンクイズ</h1>
      <a class="game" href="/">← メニューへ</a>
    </div>

    <div class="card">
      <div class="list">
        <div class="small">
          3分間、表示されたフュージョンの元ポケモン2匹の名前を入力しよう！<br />
          左右どちらの欄にどの名前を入れてもOKです。
        </div>

        <div
          class="card"
          style="display:flex;flex-direction:column;align-items:center;gap:8px;"
        >
          <img
            id="fusion-image"
            src=""
            alt="fusion"
            style="max-width:220px;max-height:220px;object-fit:contain;
                    background:#000;border-radius:12px;padding:8px;"
          />

          <div
            id="controls"
            style="display:flex;gap:8px;align-items:flex-start;pointer-events:none;opacity:0.6;"
          >
            <div
              style="flex:1;display:flex;flex-direction:column;gap:4px;"
            >
              <input id="ans1" type="text" placeholder="ポケモン名1" />
              <input id="ans2" type="text" placeholder="ポケモン名2" />
            </div>
            <div style="display:flex;flex-direction:column;gap:6px;">
              <button id="submit-btn">回答</button>
              <button id="pass-btn">パス</button>
            </div>
          </div>

          <div class="kv">
            <span class="badge">残り <b id="time">180</b>s</span>
            <span class="badge">スコア <b id="score">0</b></span>
          </div>

          <div id="feedback" class="small"></div>
          <div id="result-info" class="small"></div>
        </div>

        <div class="kv">
          <button id="start-btn">スタート</button>
        </div>

        <div class="small">
          
        </div>
      </div>
    </div>
  </div>
</body>
</html>
